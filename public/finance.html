<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SPA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
          crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous">
    </script>
</head>
<body>

<section class="vh-100">
    <!--REGISTER-VIEW-->
    <div class="container h-100" style="display: none" id="register-view">
        <div class="row d-flex justify-content-center align-items-center h-100">
            <div class="col-lg-12 col-xl-11">
                <div class="card text-black" style="border-radius: 25px;">
                    <div class="card-body p-md-5">
                        <div class="row justify-content-center">
                            <div class="col-md-10 col-lg-6 col-xl-5 order-2 order-lg-1">
                                <p class="text-center h1 fw-bold mb-5 mx-1 mx-md-4 mt-4">Register SPA account</p>
                                <div class="mx-1 mx-md-4">
                                    <form>
                                        <div class="d-flex flex-row align-items-center mb-4">
                                            <i class="fas fa-envelope fa-lg me-3 fa-fw"></i>
                                            <div class="form-outline flex-fill mb-0">
                                                <input type="text" id="register-login" class="form-control"/>
                                                <label class="form-label" for="register-login">Login</label>
                                            </div>
                                        </div>
                                        <div class="d-flex flex-row align-items-center mb-4">
                                            <i class="fas fa-lock fa-lg me-3 fa-fw"></i>
                                            <div class="form-outline flex-fill mb-0">
                                                <input type="password" id="register-password" class="form-control"/>
                                                <label class="form-label" for="register-password">Password</label>
                                            </div>
                                        </div>
                                    </form>
                                    <div class="d-flex justify-content-center mx-4 mb-3 mb-lg-4">
                                        <button class="btn btn-primary btn-lg" id="register-button">Register</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-10 col-lg-6 col-xl-7 d-flex align-items-center order-1 order-lg-2">
                                <img src="/assets/img/draw1.webp"
                                     class="img-fluid" alt="Sample image">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--REGISTER-VIEW-END-->
    <!--LOGIN-VIEW-->
    <div class="container h-100" id="login-view">
        <div class="row d-flex justify-content-center align-items-center h-100">
            <div class="col-lg-12 col-xl-11">
                <div class="card text-black" style="border-radius: 25px;">
                    <div class="card-body p-md-5">
                        <div class="row justify-content-center">
                            <div class="col-md-10 col-lg-6 col-xl-5 order-2 order-lg-1">
                                <p class="text-center h1 fw-bold mb-5 mx-1 mx-md-4 mt-4">Login SPA account</p>
                                <div class="mx-1 mx-md-4">
                                    <form>
                                        <div class="d-flex flex-row align-items-center mb-4">
                                            <i class="fas fa-envelope fa-lg me-3 fa-fw"></i>
                                            <div class="form-outline flex-fill mb-0">
                                                <input type="text" id="login-login" class="form-control"/>
                                                <label class="form-label" for="login-login">Login</label>
                                            </div>
                                        </div>
                                        <div class="d-flex flex-row align-items-center mb-4">
                                            <i class="fas fa-lock fa-lg me-3 fa-fw"></i>
                                            <div class="form-outline flex-fill mb-0">
                                                <input type="password" id="login-password" class="form-control"/>
                                                <label class="form-label" for="login-password">Password</label>
                                            </div>
                                        </div>
                                    </form>
                                    <div class="d-flex justify-content-center mx-4 mb-3 mb-lg-4">
                                        <button class="btn btn-primary btn-lg" id="login-button">Login</button>&nbsp;
                                        <button class="btn btn-primary btn-lg" id="notRegister-button">Not register
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-10 col-lg-6 col-xl-7 d-flex align-items-center order-1 order-lg-2">
                                <img src="/assets/img/draw1.webp"
                                     class="img-fluid" alt="Sample image">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--LOGIN-
    VIEW-END-->
    <div class="container h-100" style="display: none" id="operation-view">
        <div class="row d-flex justify-content-center align-items-center h-100">
            <div class="col-lg-12 col-xl-11">
                <div class="card text-black" style="border-radius: 25px;">
                    <div class="card-body p-md-5">
                        <div class="row justify-content-center">
                            <div class="col-md-10 col-lg-6 col-xl-5 order-2 order-lg-1">
                                <p class="text-center h1 fw-bold mb-5 mx-1 mx-md-4 mt-4">dfd SPA account</p>
                                <div class="mx-1 mx-md-4">
                                    <form>
                                        <div class="d-flex flex-row align-items-center mb-4">
                                            <i class="fas fa-envelope fa-lg me-3 fa-fw"></i>
                                            <div class="form-outline flex-fill mb-0">
                                                <input type="text" id="operation-login" class="form-control"/>
                                                <label class="form-label" for="login-login">Login</label>
                                            </div>
                                        </div>
                                        <div class="d-flex flex-row align-items-center mb-4">
                                            <i class="fas fa-lock fa-lg me-3 fa-fw"></i>
                                            <div class="form-outline flex-fill mb-0">
                                                <input type="password" id="operation-password" class="form-control"/>
                                                <label class="form-label" for="login-password">Password</label>
                                            </div>
                                        </div>
                                    </form>
                                    <div class="d-flex justify-content-center mx-4 mb-3 mb-lg-4">
                                        <button class="btn btn-primary btn-lg" id="operation-button">Login</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-10 col-lg-6 col-xl-7 d-flex align-items-center order-1 order-lg-2">
                                <img src="/assets/img/draw1.webp"
                                     class="img-fluid" alt="Sample image">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--TABLE-VIEW-->
    <div class="container h-100" style="display: none" id="table-view">
        <div class="row d-flex justify-content-center align-items-center h-100">
            <table class="table" id="table">
                <thead>
                <tr>
                    <th scope="col">Id</th>
                    <th scope="col">Type</th>
                    <th scope="col" id="amount">Amount</th>
                    <th scope="col">Comment</th>
                    <th scope="col">Action</th>

                </tr>
                </thead>
                <tbody id="table-tbody">
                </tbody>
            </table>
            <!--SEARCH BOX-->
            <div class="mw-50 " style="width: 400px;">
                <form class="input-group" action="/" method="GET">
                    <input type="text" id="searchByComment" name="search" class="form-control rounded"
                           placeholder="Search by comment" aria-label="Search"/>
                </form>
            </div>
            <div class="d-flex justify-content-center mx-4 mb-3 mb-lg-4">
                <button class="btn btn-primary btn-lg" id="create-operation-button" data-huy="huyn">Create new
                    operation
                </button>
                &nbsp&nbsp&nbsp&nbsp<br>
                <button class="btn btn-success btn-lg" disabled id="total-sum">
                </button>
                &nbsp
                <button class="btn btn-danger btn-lg" disabled id="total-sum-expense">
                </button>
                &nbsp
                <button class="btn btn-info btn-lg" disabled id="total-income">
                </button>
                &nbsp
                <button type="button" class="btn btn-primary btn-lg btn-block" disabled id="total-expenses">
                </button>
            </div>
        </div>
    </div>
    <!--  INPUT-OPERATION-INPUT-FORM-VIEW-->
    <div class="container h-100" style="display: none" id="input-operation-view">
        <div class="row d-flex justify-content-center align-items-center h-100">
            <div class="col-lg-12 col-xl-11">
                <div class="card text-black" style="border-radius: 25px;">
                    <div class="card-body p-md-5">
                        <div class="row justify-content-center">
                            <div class="col-md-10 col-lg-6 col-xl-5 order-2 order-lg-1">
                                <p class="text-center h1 fw-bold mb-5 mx-1 mx-md-4 mt-4">New operation</p>
                                <div class="mx-1 mx-md-4 text-center">
                                    <input type="radio" class="btn-check" name="options" id="input-income-button"
                                           autocomplete="off"
                                           checked>
                                    <label class="btn btn-secondary" for="input-income-button">Income</label>
                                    <input type="radio" class="btn-check" name="options" id="input-expense-button"
                                           autocomplete="off">
                                    <label class="btn btn-secondary" for="input-expense-button">Expense</label><br>
                                    <br>
                                    <form>
                                        <div class="d-flex flex-row align-items-center mb-4">
                                            <i class="fas fa-envelope fa-lg me-3 fa-fw"></i>
                                            <div class="form-outline flex-fill mb-0">
                                                <input type="number" min="0" oninput="validity.valid||(value='');"
                                                       style="text-align:center;"
                                                       id="new-operation-amount" class="form-control"/>
                                                <label class="form-label" for="new-operation-amount">Amount</label>
                                            </div>
                                            <div class="form-outline flex-fill mb-0">
                                                <input type="text" style="text-align:center;" id="new-operation-comment"
                                                       class="form-control"/>
                                                <label class="form-label" for="new-operation-comment">Comment</label>
                                            </div>
                                        </div>
                                    </form>
                                    <div class="d-flex justify-content-center mx-4 mb-3 mb-lg-4">
                                        <button class="btn btn-primary btn-lg" id="new-operation-button">Create</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-10 col-lg-6 col-xl-7 d-flex align-items-center order-1 order-lg-2">
                                <img src="/assets/img/draw1.webp"
                                     class="img-fluid" alt="Sample image">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--  INPUT-OPERATION-INPUT-FORM-VIEW-END-->
    <!-- Open-Operation-FORM-VIEW   -->
    <div class="container h-100" style="display: none" id="open-operation-form">
        <div class="row d-flex justify-content-center align-items-center h-100">
            <div class="col-lg-12 col-xl-11">
                <div class="card text-black" style="border-radius: 25px;">
                    <div class="card-body p-md-5">
                        <div class="row justify-content-center">
                            <div class="col-md-10 col-lg-6 col-xl-5 order-2 order-lg-1">
                                <p class="text-center h1 fw-bold mb-5 mx-1 mx-md-4 mt-4">Operation id <font
                                        color="#1e90ff">
                                    <text id="currentOperationId"></text>
                                </font></p>
                                <div class="mx-1 mx-md-4 text-center">
                                    <label class="btn btn-secondary" for="input-income-button" id="buttonIncome"
                                           disabled
                                           style="display: none">Income</label>
                                    <label class="btn btn-secondary" for="input-expense-button" id="buttonExpense"
                                           disabled
                                           style="display: none">Expense</label><br>
                                    <br>
                                    <form>
                                        <div class="d-flex flex-row align-items-center mb-4">
                                            <i class="fas fa-envelope fa-lg me-3 fa-fw"></i>
                                            <div class="form-outline flex-fill mb-0">
                                                <input type="text" min="0" style="text-align:center;"
                                                       oninput="validity.valid||(value='');"
                                                       id="amountOperation" disabled class="form-control"/>
                                                <label class="form-label" for="amountOperation">Amount</label>
                                            </div>
                                            <div class="form-outline flex-row mb-0">
                                                <input type="text" style="text-align:center;" id="commentOperation"
                                                       disabled class="form-control"/>
                                                <label class="form-label" for="commentOperation">Comment</label>
                                            </div>
                                        </div>
                                    </form>
                                    <div class="d-flex justify-content-center mx-4 mb-3 mb-lg-4">
                                        <button class="btn btn-primary btn-lg" id="open-operation-back-to-list">Back to
                                            list
                                        </button>&nbsp;
                                        <button class="btn btn-warning btn-lg" id="open-operation-delete-operation">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
    function hideAllFormsAndViews() {
        document.getElementById("login-view").style.display = "none";
        document.getElementById("register-view").style.display = "none";
        document.getElementById("table-view").style.display = "none";
        document.getElementById("open-operation-form").style.display = "none";
        document.getElementById("input-operation-view").style.display = "none";
    }

    function insertRowIntoTable(transaction) {
        let row = `<tr><th scope="row">${transaction.id}</th><td>${transaction.is_income}</td><td>${transaction.amount}</td><td>${transaction.comment}</td><td><button class="btn btn-primary btn-lg operation-open" data-id="${transaction.id}">Open</button></td></tr>`;
        document.getElementById("table-tbody").innerHTML += row;
    }

    async function showTableAndWithLastOperations() {
        const response = await fetch("/operation", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            }
        });

        await showTableAndWithProvidedOperationsFromResponse(response);
    }

    /** @param {Response} response */
    async function showTableAndWithProvidedOperationsFromResponse(response) {
        const result = await response.json();

        if (result.success === true) {
            hideAllFormsAndViews();
            document.getElementById("table-view").style.display = "block";
            document.getElementById("table-tbody").innerHTML = '';

            result.data.forEach((transaction) => {
                insertRowIntoTable(transaction)
            });

            let totalIncome = 0;
            let totalExpenses = 0;

            result.data.forEach((transaction) => {
                console.log(transaction);
                if (transaction.is_income === 1) {
                    totalIncome = totalIncome + transaction.amount;
                } else if (transaction.is_income === 0) {
                    totalExpenses = totalExpenses + transaction.amount;
                }
            });

            document.getElementById("total-sum").innerText = "Sum of the last 10 income trans  " + `${totalIncome}`;
            document.getElementById("total-sum-expense").innerText = "Sum of the last 10 expenses trans  " + `${totalExpenses}`;
            //document.getElementById("total-balance").innerText = "Total balance  " + `${totalBalance}`;


            //listened for open buttons
            let list = document.getElementsByClassName("operation-open");
            for (let item of list) {
                item.onclick = operationOpenTargetDatasetId;
            }

        } else {
            alert(result.message)
        }

        async function getTotalSum() {
            try {
                const response3 = await fetch("/totalSum", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    }
                });

                const result3 = await response3.json();
                if (result3.success === true) {
                    document.getElementById("total-income").innerText = "Ttl income " + `${result3.data.TOTAL_SUM_INCOME}`;
                } else {
                    alert(result3.message);
                }

                const response2 = await fetch("/totalSumExpense", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    }
                });

                const result2 = await response2.json();
                if (result2.success === true) {
                    document.getElementById("total-expenses").innerText = "Ttl expenses " + `${result2.data.TOTAL_SUM_EXPENSE}`;
                } else {
                    alert(result2.message);
                }


            } catch (error) {
                alert(error);
            }
        }

        await getTotalSum();
        //searchByComment
        document.getElementById("searchByComment").onkeydown = searchKeyDown;

        async function searchKeyDown() {
            setTimeout( // без задержки значение из поле получали старое
                async function () {
                    try {
                        let search = document.getElementById("searchByComment").value;
                        console.log(search);
                        const response = await fetch(`/search/?query=${search}`, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json",
                            },
                        });
                        await showTableAndWithProvidedOperationsFromResponse(response);
                    } catch (error) {
                        alert(error);
                    }
                },
                100
            )
        }
    }

    function showInputFormOperation() {

        hideAllFormsAndViews();
        document.getElementById("input-operation-view").style.display = "block";
    }

    document.getElementById("create-operation-button").onclick = showInputFormOperation;

    function openOperationBackToList() {

        hideAllFormsAndViews();
        document.getElementById("table-view").style.display = "block";

    }

    document.getElementById("open-operation-back-to-list").onclick = openOperationBackToList;

    function notRegistered() {

        hideAllFormsAndViews();
        document.getElementById("register-view").style.display = "block";
    }

    document.getElementById("notRegister-button").onclick = notRegistered;

    async function registerJSON() {

        let password = document.getElementById("register-password").value;
        let login = document.getElementById("register-login").value;
        let myObj = {login: login, password: password};
        let json = JSON.stringify(myObj);

        try {
            const response = await fetch("/register", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: json,
            });

            const result = await response.json();

            if (result.success === true) {
                await showTableAndWithLastOperations();
            } else {
                alert(result.message);
            }

        } catch (error) {
            alert(error);
        }
    }

    async function login() {
        let password = document.getElementById("login-password").value;
        let login = document.getElementById("login-login").value;
        let myObj = {login: login, password: password};
        let json = JSON.stringify(myObj);
        try {
            const response = await fetch("/login", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: json,
            });
            console.log(response);
            const result = await response.json();
            console.log(result);
            if (result.success === true) {
                await showTableAndWithLastOperations();
            } else {
                alert(result.message);
            }

        } catch (error) {
            alert(error);
        }
    }

    document.getElementById("register-button").onclick = registerJSON;
    document.getElementById("login-button").onclick = login;

    async function operationOpenTargetDatasetId(target) {
        let targetIdNumber = target.target.dataset.id;

        hideAllFormsAndViews();
        document.getElementById("open-operation-form").style.display = "block";

        let targetNumber = JSON.stringify(targetIdNumber);
        const response = await fetch(`/operation/${targetIdNumber}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: targetNumber,
        });

        const result = await response.json();
        console.log(result);
        if (result.success === true) {
            if (result.data.is_income === 1) {
                document.getElementById("buttonIncome").style.display = "block"
                document.getElementById("buttonExpense").style.display = "none"

            } else {
                document.getElementById("buttonIncome").style.display = "none"
                document.getElementById("buttonExpense").style.display = "block"
            }
            document.getElementById("commentOperation").value = `${result.data.comment}`
            document.getElementById("amountOperation").value = `${result.data.amount}`
            document.getElementById("currentOperationId").innerText = `${result.data.id}`
        }
    }

    async function operationDeleteCurrent() {
        let transactionID = document.getElementById("currentOperationId").textContent;
        try {
            await fetch(`/operation/${transactionID}`, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json",
                },
                body: transactionID,
            });

        } catch (error) {
            alert(error);
        }

        await showTableAndWithLastOperations();
        hideAllFormsAndViews();
        document.getElementById("table-view").style.display = "block";

    }

    document.getElementById("open-operation-delete-operation").onclick = operationDeleteCurrent;

    async function createNewOperation() {
        let amount = document.getElementById("new-operation-amount").value;
        let comment = document.getElementById("new-operation-comment").value;

        function isIncomeTrue() {
            if (document.getElementById("input-income-button").checked) {
                return 1;
            } else {
                return 0;
            }
        }

        let is_income = isIncomeTrue();
        let newOperationData = {amount: amount, comment: comment, is_income: is_income};
        let json = JSON.stringify(newOperationData);
        try {
            const response = await fetch("/createNewOperation", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: json,
            });

            await showTableAndWithLastOperations(response);
        } catch (error) {
            alert(error);
        }
    }

    document.getElementById("new-operation-button").onclick = createNewOperation;


</script>
</body>
</html>
